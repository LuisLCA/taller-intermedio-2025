---
title: "Informe Ocean Hack Week 2025"
subtitle: "Dinámica oceanográfica y acústica de la anchoveta en el Sistema de Corrientes de Humboldt durante el 2020–2023"
author: 
  - name: "Luis La Cruz"
    affiliation: "Ocean Hack Week 2025"
    email: "luis.lacruz@ifop.cl"
date: "17 de octubre de 2025"

format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 2
    number-sections: true
    code-fold: true
    code-tools: true
    smooth-scroll: true
    highlight-style: github
    css: styles.css

  pdf:
    documentclass: article
    toc: true
    toc-depth: 2
    number-sections: true
    colorlinks: true
    geometry: "margin=2.5cm"
    fontsize: 11pt
    mainfont: "Arial"
    sansfont: "Arial"
    monofont: "Courier New"
    highlight-style: github
    include-in-header: 
      text: |
        \usepackage[spanish]{babel}
        \usepackage{float}
        \usepackage{setspace}
        \onehalfspacing

editor: visual

execute:
  echo: false
  warning: false
  message: false
  error: false
  prefer-html: true

bibliography: references.bib
lang: es
---

```{r}
#| echo: false
#| warning: false
#install.packages(c("ncdf4", "fields", "raster"))
library(ncdf4)
library(fields)
library(raster)
library(terra)
library(ggplot2)
library(sf)
library(rnaturalearth)
library(dplyr)

```

```{r}
#| message: false
#| warning: false
# Ruta al archivo
archivo_nc <- "ERA5 monthly averaged data on single levels from 1940 to present/data_stream-moda_stepType-avgua.nc"


```

```{r}
#| message: false
#| warning: false
# Abrir archivo
nc <- nc_open(archivo_nc)

# Extraer variables
sst <- ncvar_get(nc, "sst")  # [lon, lat, tiempo]
lon <- ncvar_get(nc, "longitude")
lat <- ncvar_get(nc, "latitude")
time <- ncvar_get(nc, "valid_time")  # segundos desde 1970-01-01

# Convertir tiempo a fechas reales
fechas <- as.POSIXct(time, origin = "1970-01-01", tz = "UTC")

# Cerrar archivo
nc_close(nc)

```

```{r}
#| message: false
#| warning: false
if (is.unsorted(lat)) {
  lat <- rev(lat)
  sst <- sst[, ncol(sst):1, ]  # invertir eje latitud en toda la matriz
}

```

```{r}

coast <- ne_coastline(scale = "medium", returnclass = "sf")

sst_df <- data.frame()

for (i in 1:length(fechas)) {
  sst_mes <- t(sst[,,i] - 273.15)
  sst_mes <- sst_mes[nrow(sst_mes):1, ]
  
  r <- rast(sst_mes,
            extent = ext(min(lon), max(lon), min(lat), max(lat)),
            crs = "EPSG:4326")
  
  df_mes <- as.data.frame(r, xy = TRUE)
  names(df_mes)[3] <- "SST"  # renombrar la columna correctamente
  df_mes$Fecha <- fechas[i]
  df_mes$Mes <- format(fechas[i], "%B")
  df_mes$Year <- format(fechas[i], "%Y")
  
  sst_df <- bind_rows(sst_df, df_mes)
}

```

```{r fig.height=7, fig.width=8}
#| message: false
#| warning: false

# Reordenar los niveles del mes
sst_df$Mes <- factor(sst_df$Mes, levels = c("septiembre", "octubre", "noviembre", "diciembre"))

# Crear cortes discretos de SST
sst_df$SST_cat <- cut(sst_df$SST,
                      breaks = seq(floor(min(sst_df$SST, na.rm = TRUE)),
                                   ceiling(max(sst_df$SST, na.rm = TRUE)), by = 0.5),
                      include.lowest = TRUE)

sst_df$SST_cat <- cut(sst_df$SST,
                      breaks = seq(floor(min(sst_df$SST, na.rm = TRUE)),
                                   ceiling(max(sst_df$SST, na.rm = TRUE)), by = 1),
                      include.lowest = TRUE)


#coord_sf(crs = st_crs(4326), xlim = range(lon), ylim = range(lat), expand = FALSE)







```

# **Informe Ocean Hack Week 2025**

## Dinámica oceanográfica y acústica de la anchoveta en el Sistema de Corrientes de Humboldt durante el 2020-2023"

![](images/clipboard-1567268079.png)

-   Lenguaje: <https://www.r-project.org/>

-   Área de estudio: sur del Perú y norte de Chile.

-   Periodo: 2020, 2022 y 2023 durante los meses de septiembre a diciembre.

-   Datos satelitales: <https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels-monthly-means?tab=download> (TSM, @copernicusclimatechangeservice)

-   Datos acústicos: EK80-EK60 (38 y 120 kHz; @simmonds2005)

    ![](images/clipboard-2121590609.png){width="483"}

    [**Anchoveta** ***Engraulis ringens*** **Jenyns, 1842**](https://biodiversidadacuatica.imarpe.gob.pe/Catalogo/Especie?id=103)

    ## Motivación

    Los años 2020, 2022 y 2023 fueron seleccionados por presentar cruceros hidroacústicos consecutivos entre Perú y Chile, con fechas de camapañas compatibles en la zona fronteriza. Esta coincidencia temporal permite realizar analisis comparables del stock compartido de la anchoveta.

    +------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+
    | ![Localización de transectos acústicas de Perú (rojo) y Chile (azul) por frecuencia (38 y 120 kHz) y año.](images/clipboard-3384542142.png){width="9.6cm"} | ![](images/clipboard-3131211097.png) |
    |                                                                                                                                                            |                                      |
    |                                                                                                                                                            | Buque cientifico BIC Olaya           |
    +------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+

## Exploración de datos: imagenes satelitales

Esta figura presenta mapas mensuales de la temperatura superficial del mar (TSM) en la costa de Chile y Perú, generados a partir de datos satelitales. Cada panel corresponde a una combinación específica de año y mes, permitiendo observar la variabilidad espacio-temporal de la TSM en el Sistema de Corrientes de Humboldt.

```{r fig.height=7, fig.width=8}
ggplot(sst_df, aes(x = x, y = y, fill = SST_cat)) +
  geom_raster(interpolate = F) +
  geom_sf(data = coast, color = "gray20", size = 0.3, inherit.aes = FALSE) +
  
  scale_fill_viridis_d(name = "SST (°C)", drop = FALSE)+

  
  scale_x_continuous(breaks = seq(floor(min(lon)), ceiling(max(lon)), by = 4)) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = TRUE) +
  facet_wrap(~Year + Mes, nrow = 3, ncol = 4) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = 0.5,
    ncol = 1,
    keyheight = unit(0.8, "cm")
  ))+
  labs(
  title = "TSM mensual en la costa de chile y perú",
  x = "Longitud (°)", 
  y = "Latitud (°)",
  caption = "Fuente: Datos satelitales ERA5 procesados en Ocean Hack Week 2025"
)

```

Durante el periodo de ejecución de los cruceros hidroacústicos de Perú y Chile, que típicamente se desarrollan entre septiembre y diciembre, se ha calculado el promedio estacional de la temperatura superficial del mar (TSM) para representar las condiciones oceanográficas predominantes en la zona de estudio.

```{r fig.height=3.7, fig.width=8}
#mapa integrado

library(dplyr)

sst_anual <- sst_df %>%
  group_by(x, y, Year) %>%
  summarise(SST = mean(SST, na.rm = TRUE)) %>%
  ungroup()


sst_anual$SST_cat <- cut(sst_anual$SST,
                         breaks = seq(floor(min(sst_anual$SST, na.rm = TRUE)),
                                      ceiling(max(sst_anual$SST, na.rm = TRUE)), by = 1),
                         include.lowest = TRUE)


ggplot(sst_anual, aes(x = x, y = y, fill = SST_cat)) +
  geom_raster(interpolate = FALSE) +
  geom_sf(data = coast, color = "gray20", size = 0.3, inherit.aes = FALSE) +
  scale_fill_viridis_d(name = "SST (°C)", drop = FALSE)+
  scale_x_continuous(breaks = seq(floor(min(sst_anual$x)), ceiling(max(sst_anual$x)), by = 4)) +
  coord_sf(xlim = range(sst_anual$x), ylim = range(sst_anual$y), expand = TRUE) +
  facet_wrap(~Year, nrow = 1) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = 0.5,
    ncol = 1,
    keyheight = unit(0.8, "cm")
  ))+
labs(
  title = "TSM promedio anual en la costa de Chile y Perú (por crucero)",
  x = "Longitud (°)", 
  y = "Latitud (°)",
  caption = "Fuente: Datos satelitales ERA5 procesados en Ocean Hack Week 2025"
)



```

```{r}
# Índices para Chile
idx_chile_lat <- which(lat >= -56 & lat <= -17)
idx_chile_lon <- which(lon >= -75 & lon <= -66)

# Índices para Perú
idx_peru_lat <- which(lat >= -18 & lat <= 0)
idx_peru_lon <- which(lon >= -82 & lon <= -68)

```

```{r}
promedio_chile <- numeric(length(fechas))
promedio_peru <- numeric(length(fechas))

for (i in 1:length(fechas)) {
  sst_mes <- sst[,,i] - 273.15  # convertir a °C
  
  # Chile
  sst_chile <- sst_mes[idx_chile_lon, idx_chile_lat]
  promedio_chile[i] <- mean(sst_chile, na.rm = TRUE)
  
  # Perú
  sst_peru <- sst_mes[idx_peru_lon, idx_peru_lat]
  promedio_peru[i] <- mean(sst_peru, na.rm = TRUE)
}

```

```{r}
promedio_total_chile <- mean(promedio_chile)
promedio_total_peru  <- mean(promedio_peru)

```

```{r}
#install.packages("ggplot2")
library(ggplot2)

```

```{r}
# Vectores con promedios mensuales
#promedio_chile  # vector de SST mensual para Chile
#promedio_peru   # vector de SST mensual para Perú
#fechas          # vector de fechas (class Date)

```

```{r}
df <- data.frame(
  Fecha = rep(fechas, 2),
  SST = c(promedio_chile, promedio_peru),
  Pais = rep(c("Chile", "Perú"), each = length(fechas))
)

df$Year <- format(df$Fecha, "%Y")

```

```{r}

df_promedio_total <- aggregate(SST ~ Fecha, data = df, FUN = mean)
df_promedio_total$Fecha <- as.Date(df_promedio_total$Fecha)
df_promedio_total$Year <- format(df_promedio_total$Fecha, "%Y")

```

```{r}



```

## Promedio de la TSM durante las campañas hidroacústicas

Entre septiembre y diciembre de los años 2020, 2022 y 2023, se observa un patrón claro de incremento progresivo de la temperatura superficial del mar (TSM) desde primavera hacia verano. Perú presenta sistemáticamente valores ligeramente más altos que Chile, con diferencias promedio entre 0.3 y 0.6 °C.

```{r fig.height=4,fig.width=7}

ggplot(df, aes(x = Fecha, y = SST, color = Pais)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  geom_line(data = df_promedio_total, aes(x = Fecha, y = SST),
            color = "black", size = 1, linetype = "dashed",alpha=0.35) +

  scale_color_manual(values = c("Chile" = "blue", "Perú" = "red")) +
  labs(title = "Promedio mensual de TSM en Chile y Perú",
       subtitle = "Incluye promedio combinado (Chile + Perú, en línes punteadas de color gris)",
       x = "Mes",
       y = "SST (°C)",
       color = "País") +
  theme_bw(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 13),
    legend.position = "top"
  ) +
  facet_wrap(facets = "Year", nrow = 1, scales = "free_x")

```

```{r}
library(dplyr)
library(tidyr)

tabla_resumen <- df %>%
  mutate(Mes = format(Fecha, "%B"),
         Year = format(Fecha, "%Y")) %>%
  group_by(Year, Mes, Pais) %>%
  summarise(SST_promedio = round(mean(SST, na.rm = TRUE), 2)) %>%
  pivot_wider(names_from = Pais, values_from = SST_promedio) %>%
  left_join(
    df_promedio_total %>%
      mutate(Mes = format(Fecha, "%B"),
             Year = format(Fecha, "%Y")) %>%
      group_by(Year, Mes) %>%
      summarise(Promedio_Regional = round(mean(SST, na.rm = TRUE), 2)),
    by = c("Year", "Mes")
  ) %>%
  arrange(Year, match(Mes, c("septiembre", "octubre", "noviembre", "diciembre")))




library(knitr)
library(kableExtra)

tabla_resumen %>%
  kable(format = "html", caption = "Resumen mensual de TSM por país y promedio regional") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, position = "center") %>%
  column_spec(3:5, bold = TRUE, color = "black")



```

```{r}
#| echo: false
#| message: false
#| warning: false

library(readxl)

# Cargar la primera hoja del archivo
datos <- read_excel("cruceros-chile.xlsx", sheet = 1)

```

```{r fig.height=7,fig.width=7}
library(ggplot2)
library(viridis)
library(sf)

# === Filtrar solo el año 2023 ===
sst_2023 <- subset(sst_anual, Year == 2023)
datos_2023 <- subset(datos, Year == 2023)

# === Gráfico ===
a2023=ggplot(sst_2023, aes(x = x, y = y, fill = SST_cat)) +
  geom_raster(interpolate = FALSE) +
  geom_sf(data = coast, color = "gray20", size = 0.3, inherit.aes = FALSE) +
  scale_fill_viridis_d(name = "SST (°C)", drop = FALSE) +
  scale_x_continuous(breaks = seq(floor(min(sst_2023$x)), ceiling(max(sst_2023$x)), by = 4)) +
  coord_sf(xlim = range(sst_2023$x), ylim = range(sst_2023$y), expand = TRUE) +
  
  # Puntos base (todos)
  geom_point(data = datos_2023,
             aes(x = Lon_M, y = Lat_M),
             color = "black", shape = 21, fill = "gray70",
             size = 0.15, stroke = 0.8, inherit.aes = FALSE) +
  
  # Puntos con NASC > 0
  geom_point(data = subset(datos_2023, NASC_anc > 0),
             aes(x = Lon_M, y = Lat_M, color = log10(NASC_anc)),
             inherit.aes = FALSE) +
  
  scale_color_viridis_c(name = "Densidad sA (m²/nmi²)", option = "C") +
  theme_bw(base_size = 18) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5)
  ) +
  guides(
    fill = guide_legend(
      title.position = "top",
      title.hjust = 0.5,
      ncol = 1,
      keyheight = unit(0.8, "cm")
    )
  ) +
  labs(
    title = "2023",
    x = "Longitud (°)", 
    y = "Latitud (°)",
    caption = "Fuente: Datos ERA5 procesados en Ocean Hack Week 2025"
  )
```

## Asociación de la anchoveta y la TSM

Esta figura muestra la distribución espacial de la anchoveta en 2023, combinando datos acústicos (`NASC,`@maclennan2002) con la temperatura superficial del mar (TSM) promedio anual en la costa de Chile y Perú.

```{r fig.height=5,fig.width=7}
library(patchwork)

a2023



```
