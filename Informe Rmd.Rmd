---
title: "Informe Markdown"
author: "Luis La Cruz"
date: "2025-10-16"
output: html_document
---

```{r setup, include=FALSE,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)


#install.packages(c("ncdf4", "fields", "raster"))
library(ncdf4)
library(fields)
library(raster)
library(terra)
library(ggplot2)
library(sf)
library(rnaturalearth)
library(dplyr)
```

```{r}
# Ruta al archivo
archivo_nc <- "ERA5 monthly averaged data on single levels from 1940 to present/data_stream-moda_stepType-avgua.nc"
```

```{r}
nc <- nc_open(archivo_nc)

# Extraer variables
sst <- ncvar_get(nc, "sst")  # [lon, lat, tiempo]
lon <- ncvar_get(nc, "longitude")
lat <- ncvar_get(nc, "latitude")
time <- ncvar_get(nc, "valid_time")  # segundos desde 1970-01-01

# Convertir tiempo a fechas reales
fechas <- as.POSIXct(time, origin = "1970-01-01", tz = "UTC")

# Cerrar archivo
nc_close(nc)
```

```{r}

if (is.unsorted(lat)) {
  lat <- rev(lat)
  sst <- sst[, ncol(sst):1, ]  # invertir eje latitud en toda la matriz
}

```

```{r}
coast <- ne_coastline(scale = "medium", returnclass = "sf")

sst_df <- data.frame()

for (i in 1:length(fechas)) {
  sst_mes <- t(sst[,,i] - 273.15)
  sst_mes <- sst_mes[nrow(sst_mes):1, ]
  
  r <- rast(sst_mes,
            extent = ext(min(lon), max(lon), min(lat), max(lat)),
            crs = "EPSG:4326")
  
  df_mes <- as.data.frame(r, xy = TRUE)
  names(df_mes)[3] <- "SST"  # renombrar la columna correctamente
  df_mes$Fecha <- fechas[i]
  df_mes$Mes <- format(fechas[i], "%B")
  df_mes$Year <- format(fechas[i], "%Y")
  
  sst_df <- bind_rows(sst_df, df_mes)
}
```

```{r, fig.height=7,fig.width=8}

# Reordenar los niveles del mes
sst_df$Mes <- factor(sst_df$Mes, levels = c("septiembre", "octubre", "noviembre", "diciembre"))

# Crear cortes discretos de SST
sst_df$SST_cat <- cut(sst_df$SST,
                      breaks = seq(floor(min(sst_df$SST, na.rm = TRUE)),
                                   ceiling(max(sst_df$SST, na.rm = TRUE)), by = 0.5),
                      include.lowest = TRUE)

sst_df$SST_cat <- cut(sst_df$SST,
                      breaks = seq(floor(min(sst_df$SST, na.rm = TRUE)),
                                   ceiling(max(sst_df$SST, na.rm = TRUE)), by = 1),
                      include.lowest = TRUE)


#coord_sf(crs = st_crs(4326), xlim = range(lon), ylim = range(lat), expand = FALSE)

```

# **Informe Ocean Hack Week 2025**

## Dinámica oceanográfica y acústica de la anchoveta en el Sistema de Corrientes de Humboldt durante el 2020-2023"

![](images/clipboard-1567268079.png)

-   Lenguaje: <https://www.r-project.org/>

-   Área de estudio: sur del Perú y norte de Chile.

-   Periodo: 2020, 2022 y 2023 durante los meses de septiembre a diciembre.

-   Datos satelitales: <https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels-monthly-means?tab=download> (TSM, @copernicusclimatechangeservice)

-   Datos acústicos: EK80-EK60 (38 y 120 kHz; @simmonds2005)

    ![](images/clipboard-2121590609.png){width="483"}

    [**Anchoveta** ***Engraulis ringens*** **Jenyns, 1842**](https://biodiversidadacuatica.imarpe.gob.pe/Catalogo/Especie?id=103)

    ## Motivación

    Los años 2020, 2022 y 2023 fueron seleccionados por presentar cruceros hidroacústicos consecutivos entre Perú y Chile, con fechas de camapañas compatibles en la zona fronteriza. Esta coincidencia temporal permite realizar analisis comparables del stock compartido de la anchoveta.

    +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+
    | ![Localización de transectos acústicas de Perú (rojo) y Chile (azul) por frecuencia (38 y 120 kHz) y año.](images/clipboard-3384542142.png){alt="Localización de transectos acústicas de Perú (rojo) y Chile (azul) por frecuencia (38 y 120 kHz) y año." width="9.6cm"} | ![](images/clipboard-3131211097.png) |
    |                                                                                                                                                                                                                                                                          |                                      |
    |                                                                                                                                                                                                                                                                          | Buque cientifico BIC Olaya           |
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+

## Exploración de datos: imagenes satelitales

Esta figura presenta mapas mensuales de la temperatura superficial del mar (TSM) en la costa de Chile y Perú, generados a partir de datos satelitales. Cada panel corresponde a una combinación específica de año y mes, permitiendo observar la variabilidad espacio-temporal de la TSM en el Sistema de Corrientes de Humboldt.

```{r, fig.height=7,fig.width=8}
ggplot(sst_df, aes(x = x, y = y, fill = SST_cat)) +
  geom_raster(interpolate = F) +
  geom_sf(data = coast, color = "gray20", size = 0.3, inherit.aes = FALSE) +
  
  scale_fill_viridis_d(name = "SST (°C)", drop = FALSE)+

  
  scale_x_continuous(breaks = seq(floor(min(lon)), ceiling(max(lon)), by = 4)) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = TRUE) +
  facet_wrap(~Year + Mes, nrow = 3, ncol = 4) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = 0.5,
    ncol = 1,
    keyheight = unit(0.8, "cm")
  ))+
  labs(
  title = "TSM mensual en la costa de chile y perú",
  x = "Longitud (°)", 
  y = "Latitud (°)",
  caption = "Fuente: Datos satelitales ERA5 procesados en Ocean Hack Week 2025"
)
```
